{% extends "base.html" %}

{% block title %}Gestures{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-primary text-white">
            <div class="card-body text-center py-4">
                <h1><i class="bi bi-hand-index-thumb-fill"></i> Hand Gestures</h1>
                <p class="lead mb-3">Control your computer with hand gestures</p>
                <div class="mt-3">
                    <button id="startGestureBtn" class="btn btn-light btn-lg me-2">
                        <i class="bi bi-play-circle-fill"></i> Start Gesture Control
                    </button>
                    <button id="stopGestureBtn" class="btn btn-outline-light btn-lg" style="display: none;">
                        <i class="bi bi-stop-circle-fill"></i> Stop Gesture Control
                    </button>
                    <span id="gestureStatus" class="badge bg-secondary ms-3">Not Running</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary" id="totalGestures">{{ gestures|length }}</h3>
                <p class="mb-0">Total Gestures</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">10</h3>
                <p class="mb-0">Built-in Gestures</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-info" id="customGestures">{{ gestures|length - 10 }}</h3>
                <p class="mb-0">Custom Gestures</p>
            </div>
        </div>
    </div>
</div>

<!-- Built-in Gestures -->
<div class="row mb-4">
    <div class="col-12">
        <h3><i class="bi bi-gear-fill"></i> Built-in Gestures</h3>
        <p class="text-muted">These gestures are included by default</p>
    </div>
    
    {% for id, gesture in gestures.items() %}
    {% if id|int < 10 %}
    <div class="col-md-6 col-lg-4 mb-3">
        <div class="card h-100 border-primary">
            <div class="card-header bg-primary text-white">
                <strong>{{ gesture.name }}</strong>
                <span class="badge bg-light text-dark float-end">ID: {{ id }}</span>
            </div>
            <div class="card-body">
                <p class="card-text"><strong>Action:</strong> {{ gesture.description }}</p>
                <div class="mt-2">
                    {% if gesture.action == 'halt' %}
                        <span class="badge bg-warning">Halt</span>
                    {% elif gesture.action == 'move' %}
                        <span class="badge bg-success">Move Cursor</span>
                    {% elif 'click' in gesture.action %}
                        <span class="badge bg-info">Click</span>
                    {% elif 'scroll' in gesture.action %}
                        <span class="badge bg-secondary">Scroll</span>
                    {% else %}
                        <span class="badge bg-dark">System</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- Custom Gestures -->
<div class="row mb-4">
    <div class="col-12">
        <h3><i class="bi bi-stars"></i> Custom Gestures</h3>
        <p class="text-muted">Gestures you've created</p>
    </div>
    
    {% set has_custom = namespace(value=False) %}
    {% for id, gesture in gestures.items() %}
    {% if id|int >= 10 %}
        {% set has_custom.value = True %}
        <div class="col-md-6 col-lg-4 mb-3 custom-gesture-card" data-gesture-id="{{ id }}">
            <div class="card h-100 border-success">
                <div class="card-header bg-success text-white">
                    <strong>{{ gesture.name }}</strong>
                    <span class="badge bg-light text-dark float-end">ID: {{ id }}</span>
                </div>
                <div class="card-body">
                    <p class="card-text mb-2">
                        <strong>Action:</strong> {{ gesture.action }}
                    </p>
                    {% if gesture.action_value %}
                    <p class="card-text mb-2">
                        <strong>Target:</strong> <code>{{ gesture.action_value }}</code>
                    </p>
                    {% endif %}
                    <p class="card-text mb-2">
                        <small class="text-muted">
                            <i class="bi bi-collection"></i> {{ gesture.samples|default(0) }} samples
                        </small>
                    </p>
                    <p class="card-text mb-2">
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> Created: {{ gesture.created[:10]|default('Unknown') }}
                        </small>
                    </p>
                    
                    <div class="mt-3">
                        {% if gesture.action == 'open_app' %}
                            <span class="badge bg-primary">Open App</span>
                        {% elif gesture.action == 'search_web' %}
                            <span class="badge bg-info">Web Search</span>
                        {% endif %}
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary test-gesture-btn" data-action-type="{{ gesture.action }}" data-action-value="{{ gesture.action_value }}">
                            <i class="bi bi-play-fill"></i> Test
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-gesture-btn" data-gesture-id="{{ id }}">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    {% endfor %}
    
    {% if not has_custom.value %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No custom gestures yet. 
            <a href="/add-gesture" class="alert-link">Create your first custom gesture!</a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Gesture Button -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <a href="/add-gesture" class="btn btn-success btn-lg">
            <i class="bi bi-plus-circle-fill"></i> Create New Custom Gesture
        </a>
    </div>
</div>

<!-- How Gestures Work -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-info-circle"></i> How Gestures Work</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <i class="bi bi-camera-video display-3 text-primary"></i>
                        <h5 class="mt-2">1. Camera Capture</h5>
                        <p class="small">Webcam captures your hand</p>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="bi bi-hand-index display-3 text-success"></i>
                        <h5 class="mt-2">2. Hand Detection</h5>
                        <p class="small">MediaPipe finds 21 landmarks</p>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="bi bi-cpu display-3 text-warning"></i>
                        <h5 class="mt-2">3. AI Recognition</h5>
                        <p class="small">KNN model classifies gesture</p>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="bi bi-lightning display-3 text-danger"></i>
                        <h5 class="mt-2">4. Action</h5>
                        <p class="small">System executes command</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Test gesture action
document.querySelectorAll('.test-gesture-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const actionType = this.dataset.actionType;
        const actionValue = this.dataset.actionValue;
        
        fetch('/api/execute-action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action_type: actionType,
                action_value: actionValue
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                alert('✅ ' + data.message);
            } else {
                alert('❌ ' + data.message);
            }
        })
        .catch(err => {
            alert('❌ Error: ' + err.message);
        });
    });
});

// Delete gesture
document.querySelectorAll('.delete-gesture-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const gestureId = this.dataset.gestureId;
        
        if (!confirm('Are you sure you want to delete this gesture?')) {
            return;
        }
        
        fetch('/api/delete-gesture', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ gesture_id: gestureId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                alert('✅ Gesture deleted!');
                location.reload();
            } else {
                alert('❌ ' + data.message);
            }
        })
        .catch(err => {
            alert('❌ Error: ' + err.message);
        });
    });
});

// Gesture Control System
function checkGestureStatus() {
    fetch('/api/gesture-control-status')
        .then(res => res.json())
        .then(data => {
            updateGestureUI(data.running);
        });
}

function updateGestureUI(isRunning) {
    const startBtn = document.getElementById('startGestureBtn');
    const stopBtn = document.getElementById('stopGestureBtn');
    const status = document.getElementById('gestureStatus');
    
    if (isRunning) {
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        status.textContent = 'Running';
        status.className = 'badge bg-success ms-3';
    } else {
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        status.textContent = 'Not Running';
        status.className = 'badge bg-secondary ms-3';
    }
}

document.getElementById('startGestureBtn').addEventListener('click', function() {
    this.disabled = true;
    fetch('/api/start-gesture-control', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                alert('✅ ' + data.message + '\n\nA new window will open with gesture control.\nUse your hand gestures to control the mouse!');
                updateGestureUI(true);
            } else {
                alert('❌ ' + data.message);
            }
            this.disabled = false;
        });
});

document.getElementById('stopGestureBtn').addEventListener('click', function() {
    this.disabled = true;
    fetch('/api/stop-gesture-control', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                alert('✅ ' + data.message);
                updateGestureUI(false);
            } else {
                alert('❌ ' + data.message);
            }
            this.disabled = false;
        });
});

// Check status on load and every 5 seconds
checkGestureStatus();
setInterval(checkGestureStatus, 5000);
</script>
{% endblock %}
